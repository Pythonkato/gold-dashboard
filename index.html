<script>
  const $=id=>document.getElementById(id);
  const fmt=new Intl.NumberFormat('en-US',{maximumFractionDigits:2});

  async function j(p){
    const r=await fetch(p+`?v=${Date.now()}`);
    if(!r.ok) throw new Error(`${p} ${r.status}`);
    return r.json();
  }

  function build(arr,key){return{labels:arr.map(d=>d.date),data:arr.map(d=>Number(d[key]))};}
  function line(el,labels,datasets){
    return new Chart(el,{type:'line',data:{labels,datasets},
      options:{responsive:true,interaction:{mode:'index',intersect:false},
        plugins:{legend:{labels:{color:'#cbd5e1'}}},
        scales:{x:{ticks:{color:'#94a3b8'}},y:{ticks:{color:'#94a3b8'},grid:{color:'#1f2937'}}}});}
  (async()=>{
    const tasks = {
      dfii10: j('data/dfii10.json'),
      dxy:    j('data/dtwexbgs.json'),
      xau:    j('data/xauusd.json'),
      gld:    j('data/gld.json'),
      iau:    j('data/iau.json'),
    };
    const res = await Promise.allSettled(Object.values(tasks));
    const [dfii10,dxy,xau,gld,iau] = res.map(r=>r.status==='fulfilled'?r.value:null);

    const last = a => a?.[a.length-1];

    // KPI（取れたものだけ更新）
    try { if (xau) $('kpi-gold').textContent = '$'+fmt.format(last(xau).close); } catch {}
    try { if (dfii10) $('kpi-tips').textContent = fmt.format(last(dfii10).value)+'%'; } catch {}
    try { if (dxy) $('kpi-dxy').textContent = fmt.format(last(dxy).value); } catch {}
    try { if (gld) $('kpi-gld').textContent = fmt.format(last(gld).close); } catch {}
    try { if (iau) $('kpi-iau').textContent = fmt.format(last(iau).close); } catch {}

    // チャート（取れたものだけ描画）
    try { if (xau) { const g=build(xau,'close'); line($('#chart-gold'), g.labels,[{label:'XAUUSD',data:g.data}]); } } catch {}
    try { if (dfii10){ const t=build(dfii10,'value'); line($('#chart-tips'), t.labels,[{label:'DFII10 (real 10y)',data:t.data}]); } } catch {}
    try { if (dxy)  { const dx=build(dxy,'value');  line($('#chart-dxy'), dx.labels,[{label:'DTWEXBGS',data:dx.data}]); } } catch {}
    try {
      if (gld && iau) {
        const gg=build(gld,'close'); const ii=build(iau,'close');
        line($('#chart-etf'), gg.labels,[{label:'GLD',data:gg.data},{label:'IAU',data:ii.data}]);
      } else if (gld) {
        const gg=build(gld,'close'); line($('#chart-etf'), gg.labels,[{label:'GLD',data:gg.data}]);
      } else if (iau) {
        const ii=build(iau,'close'); line($('#chart-etf'), ii.labels,[{label:'IAU',data:ii.data}]);
      }
    } catch {}

    // 失敗ログを可視化（開発用）
    res.forEach((r,i)=>{
      if(r.status!=='fulfilled'){
        console.warn('fetch failed:', Object.keys(tasks)[i], r.reason);
      }
    });
  })();
</script>
