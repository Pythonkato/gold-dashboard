<!DOCTYPE html>
<html lang="ja" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta
    name="description"
    content="Gold Macro Dashboard は金価格・ETF・米ドル指数・実質金利など主要指標をまとめた可視化ページです。"
  />
  <title>Gold Macro Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet" />
  <script
    src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"
    integrity="sha384-Rw1QheMqgkSMD+WIOmU5Ypt/ctJxcDPpsl4pXWRgn/hEctksIA6REmoPI5DFvncA"
    crossorigin="anonymous"
    defer
  ></script>
  <style>
    :root {
      color-scheme: dark;
      --bg: #0b0d13;
      --panel: #151a24;
      --accent: #f2b544;
      --text: #f7f7f7;
      --muted: #9aa3b1;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      background:
        radial-gradient(circle at top left, rgba(242, 181, 68, 0.2), transparent 45%),
        radial-gradient(circle at bottom right, rgba(62, 83, 153, 0.2), transparent 45%),
        var(--bg);
      font-family: 'Roboto', sans-serif;
      color: var(--text);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 32px clamp(16px, 2vw, 40px);
      gap: 32px;
    }

    header {
      width: min(1200px, 100%);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    h1 {
      font-size: clamp(2rem, 3vw, 3rem);
      margin: 0;
      font-weight: 700;
      letter-spacing: 0.06em;
    }

    .subtitle {
      font-size: clamp(1rem, 1.6vw, 1.2rem);
      color: var(--muted);
      margin: 0;
      max-width: 720px;
      line-height: 1.6;
    }

    .kpi-grid {
      width: min(1200px, 100%);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .kpi-card {
      padding: 16px 20px;
      background: linear-gradient(145deg, rgba(21, 26, 36, 0.9), rgba(16, 20, 28, 0.9));
      border-radius: 16px;
      border: 1px solid rgba(242, 181, 68, 0.15);
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.25);
      display: flex;
      flex-direction: column;
      gap: 6px;
      position: relative;
      overflow: hidden;
    }

    .kpi-card::after {
      content: '';
      position: absolute;
      inset: -40% 50% auto auto;
      width: 80%;
      height: 80%;
      background: radial-gradient(circle, rgba(242, 181, 68, 0.18), transparent 70%);
      opacity: 0.6;
      pointer-events: none;
    }

    .kpi-title {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--muted);
    }

    .kpi-value {
      font-size: clamp(1.6rem, 2.6vw, 2.4rem);
      font-weight: 700;
      color: var(--text);
    }

    .kpi-change {
      font-size: 0.9rem;
      color: var(--muted);
    }

    .charts-grid {
      width: min(1200px, 100%);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 24px;
    }

    .chart-card {
      padding: 20px;
      background: linear-gradient(160deg, rgba(21, 26, 36, 0.92), rgba(12, 16, 24, 0.92));
      border-radius: 20px;
      border: 1px solid rgba(242, 181, 68, 0.12);
      box-shadow: 0 16px 30px rgba(0, 0, 0, 0.3);
    }

    .chart-title {
      margin: 0 0 12px;
      font-size: 1rem;
      font-weight: 500;
      color: var(--muted);
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    footer {
      margin-top: auto;
      width: min(1200px, 100%);
      text-align: center;
      color: var(--muted);
      font-size: 0.85rem;
    }

    a { color: var(--accent); }
  </style>
</head>
<body>
  <header>
    <h1>Gold Macro Dashboard</h1>
    <p class="subtitle">
      金市場とマクロ環境の主要指標をまとめたダッシュボードです。最新の KPI とトレンドを追跡し、
      金（XAUUSD）と代表的な ETF（GLD, IAU）、米ドル指数、10 年 TIPS 実質利回り（DFII10）を可視化します。
    </p>
  </header>

  <section class="kpi-grid" id="kpiGrid" aria-live="polite"></section>
  <section class="charts-grid" id="chartsGrid"></section>

  <footer>
    データソース: FRED, Alpha Vantage. GitHub Actions により自動更新。
  </footer>

  <script>
    const currencyFormatter = new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: 'USD',
      maximumFractionDigits: 2,
    });

    const numberFormatter = new Intl.NumberFormat('en-US', {
      maximumFractionDigits: 2,
    });

    const percentFormatter = new Intl.NumberFormat('en-US', {
      style: 'percent',
      maximumFractionDigits: 2,
    });

    const DATASETS = [
      {
        id: 'xauusd',
        label: 'Gold Spot (XAUUSD)',
        path: 'data/xauusd.json',
        valueKey: 'close',
        formatter: (v) => currencyFormatter.format(Number(v)),
      },
      {
        id: 'gld',
        label: 'GLD ETF',
        path: 'data/gld.json',
        valueKey: 'adjusted_close',
        formatter: (v) => currencyFormatter.format(Number(v)),
      },
      {
        id: 'iau',
        label: 'IAU ETF',
        path: 'data/iau.json',
        valueKey: 'adjusted_close',
        formatter: (v) => currencyFormatter.format(Number(v)),
      },
      {
        id: 'dtwexbgs',
        label: 'Trade-Weighted USD Index (DTWEXBGS)',
        path: 'data/dtwexbgs.json',
        valueKey: 'value',
        formatter: (v) => numberFormatter.format(Number(v)),
      },
      {
        id: 'dfii10',
        label: '10y TIPS Real Yield (DFII10)',
        path: 'data/dfii10.json',
        valueKey: 'value',
        formatter: (v) => `${numberFormatter.format(Number(v))}%`,
      },
    ];

    const colors = [
      'rgba(242, 181, 68, 0.85)',
      'rgba(66, 163, 244, 0.85)',
      'rgba(144, 238, 144, 0.85)',
      'rgba(255, 99, 132, 0.85)',
      'rgba(153, 102, 255, 0.85)',
    ];

    async function loadDataset(dataset) {
      const response = await fetch(dataset.path, { cache: 'no-cache' });
      if (!response.ok) {
        throw new Error(`Failed to load ${dataset.label}`);
      }
      const payload = await response.json();
      const records = Array.isArray(payload) ? payload : payload.data;

      return records
        .filter((entry) => entry[dataset.valueKey] !== null && entry[dataset.valueKey] !== undefined)
        .map((entry) => ({
          date: entry.date,
          value: Number(entry[dataset.valueKey]),
        }))
        .filter((entry) => Number.isFinite(entry.value))
        .sort((a, b) => new Date(a.date) - new Date(b.date));
    }

    function computeChange(latest, previous) {
      if (!Number.isFinite(latest) || !Number.isFinite(previous) || previous === 0) {
        return null;
      }
      return ((latest - previous) / previous) * 100;
    }

    function createKpiCard(dataset, latestPoint, change) {
      const card = document.createElement('article');
      card.className = 'kpi-card';

      const title = document.createElement('span');
      title.className = 'kpi-title';
      title.textContent = dataset.label;

      const value = document.createElement('span');
      value.className = 'kpi-value';
      value.textContent = dataset.formatter(latestPoint.value);

      const changeEl = document.createElement('span');
      changeEl.className = 'kpi-change';
      if (change === null) {
        changeEl.textContent = '前日比を計算できません';
      } else {
        const formatted = percentFormatter.format(change / 100);
        const isPositive = change >= 0;
        changeEl.textContent = `${isPositive ? '▲' : '▼'} ${formatted}（前日比）`;
        changeEl.style.color = isPositive ? 'var(--accent)' : '#ff6b6b';
      }

      card.appendChild(title);
      card.appendChild(value);
      card.appendChild(changeEl);

      return card;
    }

    function createChart(dataset, series, color) {
      const card = document.createElement('article');
      card.className = 'chart-card';

      const title = document.createElement('h2');
      title.className = 'chart-title';
      title.textContent = dataset.label;

      const canvas = document.createElement('canvas');
      canvas.setAttribute('role', 'img');
      canvas.setAttribute('aria-label', `${dataset.label} chart`);

      card.appendChild(title);
      card.appendChild(canvas);

      new window.Chart(canvas.getContext('2d'), {
        type: 'line',
        data: {
          labels: series.map((point) => point.date),
          datasets: [
            {
              label: dataset.label,
              data: series.map((point) => point.value),
              borderColor: color,
              backgroundColor: color.replace('0.85', '0.2'),
              fill: true,
              tension: 0.25,
              borderWidth: 2,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              ticks: { color: 'var(--muted)', maxTicksLimit: 6 },
              grid: { color: 'rgba(255, 255, 255, 0.05)' },
            },
            y: {
              ticks: {
                color: 'var(--muted)',
                callback: (value) => {
                  const formatted = dataset.formatter ? dataset.formatter(value) : value;
                  return typeof formatted === 'string' ? formatted.replace('$', '$ ') : formatted;
                },
              },
              grid: { color: 'rgba(255, 255, 255, 0.05)' },
            },
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (context) => {
                  const val = context.parsed.y;
                  const formattedValue = dataset.formatter ? dataset.formatter(val) : val;
                  const date = context.label;
                  return `${date}: ${formattedValue}`;
                },
              },
            },
          },
        },
      });

      const height = window.innerWidth < 768 ? 240 : 320;
      canvas.style.width = '100%';
      canvas.style.height = `${height}px`;

      return card;
    }

    async function initDashboard() {
      const kpiGrid = document.getElementById('kpiGrid');
      const chartsGrid = document.getElementById('chartsGrid');

      const skeleton = Array.from({ length: DATASETS.length }).map(() => {
        const card = document.createElement('article');
        card.className = 'kpi-card';
        card.textContent = 'Loading...';
        kpiGrid.appendChild(card);
        return card;
      });

      try {
        const seriesList = await Promise.all(DATASETS.map(loadDataset));

        skeleton.forEach((node) => node.remove());

        seriesList.forEach((series, index) => {
          const dataset = DATASETS[index];
          if (series.length < 2) return;

          const latestPoint = series[series.length - 1];
          const previousPoint = series[series.length - 2];
          const change = computeChange(latestPoint.value, previousPoint.value);

          kpiGrid.appendChild(createKpiCard(dataset, latestPoint, change));
          chartsGrid.appendChild(createChart(dataset, series, colors[index % colors.length]));
        });
      } catch (error) {
        skeleton.forEach((node) => node.remove());
        const errorEl = document.createElement('p');
        errorEl.textContent = `データの取得に失敗しました: ${error.message}`;
        errorEl.style.color = '#ff6b6b';
        kpiGrid.appendChild(errorEl);
      }
    }

    window.addEventListener('DOMContentLoaded', () => {
      if (!window.Chart) {
        console.error('Chart.js failed to load');
        return;
      }
      initDashboard();
    });
  </script>
</body>
</html>
