<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Gold Macro Dashboard</title>
<style>
  :root { --bg:#0b1220; --card:#0f172a; --line:#1f2937; --text:#e5e7eb; --muted:#94a3b8; }
  html,body{height:100%}
  body{background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:0}
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
  .kpis{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:12px;margin:12px 0 24px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px}
  .k{font-size:12px;color:var(--muted)} .v{font-size:20px;margin-top:4px}
  canvas{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:8px}
  .g{display:grid;grid-template-columns:1fr;gap:16px}
  .debug{white-space:pre-wrap;background:#111827;border:1px dashed #374151;color:#d1d5db;border-radius:8px;padding:8px;margin:16px 0;display:none}
  .boot{font-size:12px;color:#93c5fd;margin:8px 0}
  a, a:visited { color:#93c5fd; }
</style>

<!-- 重要：外部CDNではなく、リポジトリ同梱の Chart.js を参照 -->
<script src="vendor/chart.umd.min.js" defer></script>

<script defer>
(function(){
  const $ = id => document.getElementById(id);
  const boot = m => { const el=$('boot'); if(el) el.textContent = m; };
  const show = m => { const box=$('debug'); box.style.display='block'; box.textContent += m+'\n'; console.log(m); };

  boot('booting…');

  const fmt = new Intl.NumberFormat('en-US',{maximumFractionDigits:2});

  async function j(p){
    const url = p + `?v=${Date.now()}`; // cache bust
    const r = await fetch(url);
    if(!r.ok) throw new Error(`${p} ${r.status}`);
    return r.json(); // expects array
  }

  function build(arr,key){ return {labels:arr.map(d=>d.date), data:arr.map(d=>Number(d[key]))}; }

  function line(el,labels,datasets){
    if(!el) throw new Error('canvas not found');
    if(!window.Chart) throw new Error('Chart.js is not available');
    return new Chart(el,{type:'line',data:{labels,datasets},
      options:{responsive:true,interaction:{mode:'index',intersect:false},
        plugins:{legend:{labels:{color:'#cbd5e1'}}},
        scales:{x:{ticks:{color:'#94a3b8'}},y:{ticks:{color:'#94a3b8'},grid:{color:'#1f2937'}}}});
  }
  
  window.addEventListener('DOMContentLoaded', async ()=>{
    try{
      // Chart.js 読み込み確認
      if(!window.Chart){
        show('Chart.js が読み込まれていません。vendor/chart.umd.min.js のパス/存在を確認してください。');
        return;
      }
      boot('Chart.js ready');

      // データ読み込み（部分表示 OK）
      const tasks = {
        dfii10: j('data/dfii10.json'),   // [{date,value}]
        dxy:    j('data/dtwexbgs.json'), // [{date,value}]
        xau:    j('data/xauusd.json'),   // [{date,close}]
        gld:    j('data/gld.json'),      // [{date,close,...}]
        iau:    j('data/iau.json'),      // [{date,close,...}]
      };
      const names = Object.keys(tasks);
      const res = await Promise.allSettled(Object.values(tasks));
      const map = Object.fromEntries(res.map((r,i)=>[names[i], r.status==='fulfilled'?r.value:null]));
      names.forEach((k,i)=>{ if(res[i].status!=='fulfilled'){ show(`fetch failed: ${k} → ${res[i].reason}`); } });

      const last = a => a?.[a.length-1];

      // KPI
      try { if (map.xau)   $('kpi-gold').textContent = '$'+fmt.format(last(map.xau).close); } catch(e){ show('kpi gold: '+e); }
      try { if (map.dfii10)$('kpi-tips').textContent = fmt.format(last(map.dfii10).value)+'%'; } catch(e){ show('kpi tips: '+e); }
      try { if (map.dxy)   $('kpi-dxy').textContent  = fmt.format(last(map.dxy).value); } catch(e){ show('kpi dxy: '+e); }
      try { if (map.gld)   $('kpi-gld').textContent  = fmt.format(last(map.gld).close); } catch(e){ show('kpi gld: '+e); }
      try { if (map.iau)   $('kpi-iau').textContent  = fmt.format(last(map.iau).close); } catch(e){ show('kpi iau: '+e); }

      // Charts
      try { if (map.xau)    { const g = build(map.xau,'close'); line($('#chart-gold'), g.labels,[{label:'XAUUSD',data:g.data}]); } } catch(e){ show('chart gold: '+e); }
      try { if (map.dfii10) { const t = build(map.dfii10,'value'); line($('#chart-tips'), t.labels,[{label:'DFII10 (real 10y)',data:t.data}]); } } catch(e){ show('chart tips: '+e); }
      try { if (map.dxy)    { const dx= build(map.dxy,'value');  line($('#chart-dxy'),  dx.labels,[{label:'DTWEXBGS',data:dx.data}]); } } catch(e){ show('chart dxy: '+e); }
      try {
        const etf = $('#chart-etf');
        if (map.gld && map.iau) {
          const gg=build(map.gld,'close'); const ii=build(map.iau,'close');
          line(etf, gg.labels,[{label:'GLD',data:gg.data},{label:'IAU',data:ii.data}]);
        } else if (map.gld) {
          const gg=build(map.gld,'close'); line(etf, gg.labels,[{label:'GLD',data:gg.data}]);
        } else if (map.iau) {
          const ii=build(map.iau,'close'); line(etf, ii.labels,[{label:'IAU',data:ii.data}]);
        }
      } catch(e){ show('chart etf: '+e); }

    }catch(e){
      show('fatal: '+e);
    }
  });
})();
</script>
</head>
<body>
  <div class="wrap">
    <h1>Gold Macro Dashboard</h1>
    <div id="boot" class="boot">booting…</div>

    <div class="kpis">
      <div class="card"><div class="k">Gold (XAUUSD)</div><div class="v" id="kpi-gold">—</div></div>
      <div class="card"><div class="k">10y TIPS real (DFII10)</div><div class="v" id="kpi-tips">—</div></div>
      <div class="card"><div class="k">Trade-weighted USD (DTWEXBGS)</div><div class="v" id="kpi-dxy">—</div></div>
      <div class="card"><div class="k">GLD</div><div class="v" id="kpi-gld">—</div></div>
      <div class="card"><div class="k">IAU</div><div class="v" id="kpi-iau">—</div></div>
    </div>

    <div class="g">
      <canvas id="chart-gold" height="120"></canvas>
      <canvas id="chart-tips" height="120"></canvas>
      <canvas id="chart-dxy"  height="120"></canvas>
      <canvas id="chart-etf"  height="120"></canvas>
    </div>

    <div id="debug" class="debug"></div>

    <p style="color:#94a3b8;font-size:12px;">
      Data: FRED (DFII10, DTWEXBGS), Alpha Vantage / FRED (XAUUSD/Gold), ETFs (GLD/IAU).
    </p>
  </div>
</body>
</html>
